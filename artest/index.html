<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - trackball controls</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #000;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;

				background-color: #000;
				margin: 0px;
				overflow: hidden;
			}

			#container {
			position: absolute;
			  top: 0;
			  left: 0;
			  width: 100%;
			  height: 100%;
			}

			/*.parent {
			  position: relative;
			  width: 1024px;
			  height: 768px;
			}
			#monitor, #mainCanvas {
			  position: absolute;
			  top: 0;
			  left: 0;
			  width: 100%;
			  height: 100%;
			}
			#monitor {
			  transform: scaleX(-1);
			}*/
		</style>
	</head>

	<body>
		<video autoplay style="width: 480px;height: 320px"></video>
		<!-- <div id="container"></div> -->

		<script src="libs/three.js"></script>

		<script src="libs/TrackballControls.js"></script>

		<!-- <script src="js/Detector.js"></script> -->
		<script src="libs/stats.min.js"></script>

		<!-- div class="parent">
		  <div id="monitor"></div>
		  <div id="mainCanvas"></div>
		</div> -->

		<script>

			// if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, stats;

			var camera, controls, scene, renderer;

			 function hasUserMedia(){//判断是否支持调用设备api，因为浏览器不同所以判断方式不同哦    
        return !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);    
    }    
    if(hasUserMedia()){    
        //alert("浏览器支持")    
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;    
        navigator.getUserMedia({    
            video:true,//开启视频    
            audio:false//先关闭音频，因为会有回响，以后两台电脑通信不会有响声    
        },function(stream){//将视频流交给video    
            var video=document.querySelector("video");    
            video.src=window.URL.createObjectURL(stream);       
        },function(err){    
            console.log("capturing",err)    
        });    
    }else{    
        alert("浏览器暂不支持")    
    } 



		/*	// 老的浏览器可能根本没有实现 mediaDevices，所以我们可以先设置一个空的对象
			if (navigator.mediaDevices === undefined) {
			  navigator.mediaDevices = {};
			}

			// 一些浏览器部分支持 mediaDevices。我们不能直接给对象设置 getUserMedia 
			// 因为这样可能会覆盖已有的属性。这里我们只会在没有getUserMedia属性的时候添加它。
			if (navigator.mediaDevices.getUserMedia === undefined) {
			  navigator.mediaDevices.getUserMedia = function(constraints) {

			    // 首先，如果有getUserMedia的话，就获得它
			    var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

			    // 一些浏览器根本没实现它 - 那么就返回一个error到promise的reject来保持一个统一的接口
			    if (!getUserMedia) {
			      return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
			    }

			    // 否则，为老的navigator.getUserMedia方法包裹一个Promise
			    return new Promise(function(resolve, reject) {
			      getUserMedia.call(navigator, constraints, resolve, reject);
			    });
			  }
			}*/

			//访问用户媒体设备的兼容方法
			function getUserMedia(constrains,success,error){
			    if(navigator.mediaDevices.getUserMedia){
			        //最新标准API
			        navigator.mediaDevices.getUserMedia(constrains).then(success).catch(error);
			    } else if (navigator.webkitGetUserMedia){
			        //webkit内核浏览器
			        navigator.webkitGetUserMedia(constrains).then(success).catch(error);
			    } else if (navigator.mozGetUserMedia){
			        //Firefox浏览器
			        navagator.mozGetUserMedia(constrains).then(success).catch(error);
			    } else if (navigator.getUserMedia){
			        //旧版API
			        navigator.getUserMedia(constrains).then(success).catch(error);
			    }
			}
		

			function handleSuccess(stream) {
			  // window.stream = stream; // only to make stream available to console
			  var video = document.querySelector('video');
			    // 旧的浏览器可能没有srcObject
			  if ("srcObject" in video) {
			    video.srcObject = stream;
			  } else {
			    // 防止再新的浏览器里使用它，应为它已经不再支持了
			    var CompatibleURL = window.URL || window.webkitURL;
			    video.src = CompatibleURL.createObjectURL(stream);
			  }
			  // video.onloadedmetadata = function(e) {
			    video.play();
			  // };
			}

			function handleError(err) {
			  alert(err.name + ": " + err.message); 
			}
			// navigator.mediaDevices.getUserMedia({
			//   video: { facingMode: { exact: "environment" } }//user
			// }).then(handleSuccess).catch(handleError);

			if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia){
			    //调用用户媒体设备，访问摄像头
				//getUserMedia({"video": true },handleSuccess,handleError);
			} else {
			    alert("你的浏览器不支持访问用户媒体设备");
			}


			init();
			animate();

			function init() {

				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.z = 500;

				controls = new THREE.TrackballControls( camera );

				controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.8;

				controls.noZoom = false;
				controls.noPan = false;

				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;

				controls.keys = [ 65, 83, 68 ];

				controls.addEventListener( 'change', render );

				// world

				scene = new THREE.Scene();
				// scene.background = new THREE.Color( 0xcccccc );
				// scene.fog = new THREE.FogExp2( 0xcccccc, 0.002 );

				var geometry = new THREE.CylinderGeometry( 0, 10, 30, 4, 1 );
				var material = new THREE.MeshPhongMaterial( { color: 0xffffff, flatShading: true } );

				for ( var i = 0; i < 500; i ++ ) {

					var mesh = new THREE.Mesh( geometry, material );
					mesh.position.x = ( Math.random() - 0.5 ) * 1000;
					mesh.position.y = ( Math.random() - 0.5 ) * 1000;
					mesh.position.z = ( Math.random() - 0.5 ) * 1000;
					mesh.updateMatrix();
					mesh.matrixAutoUpdate = false;
					scene.add( mesh );

				}


				// lights

				var light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 1, 1, 1 );
				scene.add( light );

				var light = new THREE.DirectionalLight( 0x002288 );
				light.position.set( -1, -1, -1 );
				scene.add( light );

				var light = new THREE.AmbientLight( 0x222222 );
				scene.add( light );


				// renderer

				renderer = new THREE.WebGLRenderer( { antialias: false,alpha: true } );
				renderer.setClearAlpha(0.0);
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				container = document.getElementById( 'container' );
				container.appendChild( renderer.domElement );

				stats = new Stats();
				container.appendChild( stats.dom );

				//

				window.addEventListener( 'resize', onWindowResize, false );
				//

				render();

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				controls.handleResize();

				render();

			}

			function animate() {

				requestAnimationFrame( animate );
				controls.update();

			}

			function render() {

				renderer.render( scene, camera );
				stats.update();

			}


		</script>

	</body>
</html>
